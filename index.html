// üì¶ script.js ‚Äî Sklad Kalkulyator Web logikasi

const productsBody = document.getElementById('productsBody');
const totalItems = document.getElementById('totalItems');
const totalPrice = document.getElementById('totalPrice');
const totalBonus = document.getElementById('totalBonus');
const addProductBtn = document.getElementById('addProductBtn');
const searchInput = document.getElementById('searchInput');
const saveBtn = document.getElementById('saveBtn');
const downloadExcel = document.getElementById('downloadExcel');
const downloadPdf = document.getElementById('downloadPdf');
const toggleDark = document.getElementById('toggleDark');
const chartCanvas = document.getElementById('chartCanvas');

let products = [];

function createProductRow(id) {
  const tr = document.createElement('tr');
  tr.dataset.id = id;
  tr.innerHTML = `
    <td><input type="text" class="name" placeholder="Nom..." /></td>
    <td><input type="text" class="category" placeholder="Kategoriya..." /></td>
    <td><input type="number" class="boxes" min="0" value="0" /></td>
    <td><input type="number" class="perBox" min="0" value="0" /></td>
    <td class="totalItemsCell">0</td>
    <td class="priceCell">0</td>
    <td>
      <select class="bonusSelect">
        <option value="0">Yo'q</option>
        <option value="4+1">4+1</option>
        <option value="5+1">5+1</option>
        <option value="10+2">10+2</option>
      </select>
    </td>
    <td class="bonusResult">0 / 0</td>
    <td><button class="remove">‚ùå</button></td>
  `;

  const boxes = tr.querySelector('.boxes');
  const perBox = tr.querySelector('.perBox');
  const totalItemsCell = tr.querySelector('.totalItemsCell');
  const priceCell = tr.querySelector('.priceCell');
  const bonusSelect = tr.querySelector('.bonusSelect');
  const bonusResult = tr.querySelector('.bonusResult');

  function updateRow() {
    const boxVal = parseInt(boxes.value) || 0;
    const perVal = parseInt(perBox.value) || 0;
    const total = boxVal * perVal;
    totalItemsCell.textContent = total;

    const price = (total * 1000); // narx = umumiy * 1000 (misol uchun)
    priceCell.textContent = price.toLocaleString();

    // Aksiya hisoblash
    let bonusDona = 0, bonusBox = 0;
    if (bonusSelect.value === '4+1') {
      bonusBox = Math.floor(boxVal / 4);
      bonusDona = bonusBox * perVal;
    } else if (bonusSelect.value === '5+1') {
      bonusBox = Math.floor(boxVal / 5);
      bonusDona = bonusBox * perVal;
    } else if (bonusSelect.value === '10+2') {
      bonusBox = Math.floor(boxVal / 10) * 2;
      bonusDona = bonusBox * perVal;
    }
    bonusResult.textContent = `${bonusDona} / ${bonusBox}`;

    updateTotals();
  }

  boxes.addEventListener('input', updateRow);
  perBox.addEventListener('input', updateRow);
  bonusSelect.addEventListener('change', updateRow);
  tr.querySelector('.remove').addEventListener('click', () => {
    products = products.filter(p => p !== id);
    tr.remove();
    updateTotals();
  });

  return tr;
}

function updateTotals() {
  let totalCount = 0;
  let totalCost = 0;
  let totalBonusItems = 0;
  let totalBonusBoxes = 0;

  productsBody.querySelectorAll('tr').forEach(tr => {
    const totalCell = parseInt(tr.querySelector('.totalItemsCell').textContent) || 0;
    const price = parseInt(tr.querySelector('.priceCell').textContent.replace(/\D/g, '')) || 0;
    const bonusText = tr.querySelector('.bonusResult').textContent.split('/');
    const bonusItems = parseInt(bonusText[0]) || 0;
    const bonusBoxes = parseInt(bonusText[1]) || 0;

    totalCount += totalCell;
    totalCost += price;
    totalBonusItems += bonusItems;
    totalBonusBoxes += bonusBoxes;
  });

  totalItems.textContent = `Jami elementlar: ${totalCount}`;
  totalPrice.textContent = `Jami summa: ${totalCost.toLocaleString()} so‚Äòm`;
  totalBonus.textContent = `Aksiyadan olingan: ${totalBonusItems} dona / ${totalBonusBoxes} quti`;

  updateChart();
}

// üìä Chart JS
let chart;
function updateChart() {
  const labels = [];
  const data = [];

  productsBody.querySelectorAll('tr').forEach(tr => {
    const name = tr.querySelector('.name').value || 'Noma‚Äôlum';
    const price = parseInt(tr.querySelector('.priceCell').textContent.replace(/\D/g, '')) || 0;
    labels.push(name);
    data.push(price);
  });

  if (chart) chart.destroy();
  chart = new Chart(chartCanvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Narxlar (so‚Äòm)',
        data,
        backgroundColor: '#007bff',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

addProductBtn.addEventListener('click', () => {
  const id = Date.now();
  products.push(id);
  const row = createProductRow(id);
  productsBody.appendChild(row);
});

searchInput.addEventListener('input', () => {
  const val = searchInput.value.toLowerCase();
  productsBody.querySelectorAll('tr').forEach(tr => {
    const name = tr.querySelector('.name').value.toLowerCase();
    tr.style.display = name.includes(val) ? '' : 'none';
  });
});

saveBtn.addEventListener('click', () => {
  const html = document.querySelector('.container').outerHTML;
  localStorage.setItem('skladBackup', html);
  alert('Saqlab qo‚Äòyildi!');
});

downloadExcel.addEventListener('click', () => {
  const wb = XLSX.utils.book_new();
  const data = [['Mahsulot', 'Kategoriya', 'Qutilar', '1 Qutidagi', 'Jami', 'Narx', 'Bonus']];
  productsBody.querySelectorAll('tr').forEach(tr => {
    data.push([
      tr.querySelector('.name').value,
      tr.querySelector('.category').value,
      tr.querySelector('.boxes').value,
      tr.querySelector('.perBox').value,
      tr.querySelector('.totalItemsCell').textContent,
      tr.querySelector('.priceCell').textContent,
      tr.querySelector('.bonusResult').textContent
    ]);
  });
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, 'Sklad');
  XLSX.writeFile(wb, 'sklad.xlsx');
});

downloadPdf.addEventListener('click', () => {
  html2pdf().from(document.querySelector('.container')).save('sklad.pdf');
});

toggleDark.addEventListener('click', () => {
  document.body.classList.toggle('dark');
});

// Dastlab 1 qator qo‚Äòshish
addProductBtn.click();
